<div class="home">
  <div class="home__header">
    <div class="home__header-left">
      <h1 class="home__title">Consultas Agendadas</h1>
      <p class="home__subtitle">Lista das últimas consultas odontológicas</p>
    </div>
    <!-- APPOINTMENTS FILTERED BY DATE -->
    <div class="home__header-right">
      <mat-form-field appearance="fill">
        <mat-label>Filtrar por data</mat-label>
        <input
          matInput
          [matDatepicker]="picker"
          [(ngModel)]="selectedDate"
          (dateChange)="filteredByDate()"
        />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <div class="home__clear-filter">
        <button mat-button (click)="clearFilter()">Limpar filtro</button>
      </div>
    </div>
  </div>

  <div class="home__table-wrapper">
    <table class="home__table">
      <thead class="home__thead">
        <tr>
          <th class="home__th">Paciente</th>
          <th class="home__th">Dentista</th>
          <th class="home__th">Data</th>
          <th class="home__th">Hora</th>
          <th class="home__th">Status</th>
          <th class="home__th">Ações</th>
        </tr>
      </thead>
      <tbody class="home__tbody">
        <tr class="home__row" *ngFor="let appointment of appointments$ | async">
          <td class="home__td">{{ appointment.patient.name }}</td>
          <td class="home__td">{{ appointment.dentist.name }}</td>
          <td class="home__td">{{ appointment.date | date : 'dd/MM/yyyy' }}</td>
          <td class="home__td">{{ appointment.date | date : 'HH:mm' }}</td>
          <td class="home__td">
            <span>
              {{ appointment.status | appointmentStatus }}
            </span>
          </td>

          <td class="home__td">
            <button
              class="home__btn home__btn--view"
              aria-label="Ver consulta"
              (click)="openAppointmentDetails(appointment.id!)"
            >
              Ver
            </button>
            @if(!dentistLogged){
            <button
              class="home__btn home__btn--edit"
              aria-label="Editar consulta"
              (click)="onEditAppointment(appointment)"
              [disabled]="
                appointment.status === AppointmentStatus.CANCELED ||
                appointment.status === AppointmentStatus.COMPLETED
              "
            >
              Alterar
            </button>
            <button
              class="home__btn home__btn--cancel"
              aria-label="Cancelar consulta"
              (click)="onCancelAppointment(appointment.id!)"
              [disabled]="
                appointment.status === AppointmentStatus.CANCELED ||
                appointment.status === AppointmentStatus.COMPLETED
              "
            >
              Cancelar
            </button>
            }
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="(appointments$ | async)?.length === 0" class="home__no-results">
      Nenhuma consulta encontrada.
    </div>
  </div>
  <!-- PAGINATION -->
  <nav *ngIf="pageInfo?.page && pageInfo.page.totalPages > 1" aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-3">
      <li class="page-item" [class.disabled]="pageInfo.page.number === 0">
        <button
          class="page-link"
          (click)="goToPage(pageInfo.page.number - 1)"
          [disabled]="pageInfo.page.number === 0"
        >
          Anterior
        </button>
      </li>
      <li
        class="page-item"
        *ngFor="let page of [].constructor(pageInfo.page.totalPages); let i = index"
        [class.active]="i === pageInfo.page.number"
      >
        <button class="page-link" (click)="goToPage(i)">
          {{ i + 1 }}
        </button>
      </li>
      <li
        class="page-item"
        [class.disabled]="pageInfo.page.number === pageInfo.page.totalPages - 1"
      >
        <button
          class="page-link"
          (click)="goToPage(pageInfo.page.number + 1)"
          [disabled]="pageInfo.page.number === pageInfo.page.totalPages - 1"
        >
          Próxima
        </button>
      </li>
    </ul>
  </nav>
</div>

<!-- APPOINTMENT DETAILS MODAL -->
<app-appointment-details-modal
  *ngIf="showAppointmentDetailsModal && selectedAppointment"
  [appointment]="selectedAppointment"
  (close)="closeModal()"
></app-appointment-details-modal>

<!-- EDIT APPOINTMENT MODAL -->
<div class="modal-backdrop" *ngIf="showEditAppointmentModal" (click)="closeEditModal()"></div>
<div *ngIf="showEditAppointmentModal" class="modal-overlay">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <h2>Editar Consulta</h2>

      <form #editForm="ngForm" (ngSubmit)="updateAppointment()">
        <div class="modal-body">
          <label for="description"><strong>Descrição:</strong></label>
          <input
            type="text"
            id="description"
            name="description"
            [(ngModel)]="editedAppointment.description"
            required
            class="form-control"
          />

          <label for="date"><strong>Data e Hora:</strong></label>
          <input
            type="datetime-local"
            id="date"
            name="date"
            [(ngModel)]="editedAppointment.date"
            required
            class="form-control"
          />
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-success" [disabled]="!editForm.form.valid">
            Salvar
          </button>
        </div>
        <div
          *ngIf="editMessage"
          class="edit-message"
          [ngClass]="{ success: editSuccess, error: !editSuccess }"
        >
          {{ editMessage }}
        </div>
      </form>
    </div>
  </div>
</div>
